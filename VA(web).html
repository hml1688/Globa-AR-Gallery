<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>V&A artworks · by place & date range</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:1rem}
  form{margin-bottom:1rem}
  input{width:6rem;margin-right:.5rem;padding:.25rem}
  button{padding:.3rem .8rem}
  #grid{display:flex;flex-wrap:wrap;gap:1rem}
  .item{width:200px;text-align:center}
  .item img{width:100%;border-radius:6px;cursor:pointer}
  .msg{margin-top:1rem;font-style:italic}
</style>
</head>
<body>

<h2>Victoria & Albert Museum · South America</h2>

<form id="qry">
  From year: <input id="yearFrom" placeholder="e.g. 1800" required>
  To year: <input id="yearTo" placeholder="e.g. 1900" required>
  <button type="submit">Search</button>
</form>

<div id="grid"></div>
<p class="msg" id="msg"></p>

<script>
const PLACE = "South America";          // 可改成其他国家或用 id_place
const SAMPLE_SIZE = 12;         // 随机展示数量
const PAGE_SIZE   = 100;        // 取回的最大记录数（API 上限 100）

const grid = document.getElementById('grid');
const msg  = document.getElementById('msg');

document.getElementById('qry').addEventListener('submit', e => {
  e.preventDefault();
  const fromYear = parseInt(document.getElementById('yearFrom').value, 10);
  const toYear   = parseInt(document.getElementById('yearTo').value, 10);
  if (isNaN(fromYear) || isNaN(toYear)) { alert('Please enter valid years'); return; }
  fetchArtworks(Math.min(fromYear,toYear), Math.max(fromYear,toYear));
});

async function fetchArtworks(fromY, toY){
  grid.innerHTML = '';
  msg.textContent = 'Loading…';

  const endpoint = `https://api.vam.ac.uk/v2/objects/search?` +
    `q_place_name=${encodeURIComponent(PLACE)}` +
    `&year_made_from=${fromY}&year_made_to=${toY}` +
    `&images_exist=1&page_size=${PAGE_SIZE}`;

  try{
    const {records} = await fetch(endpoint).then(r => r.json());
    const picks = records.sort(() => 0.5 - Math.random()).slice(0, SAMPLE_SIZE);
    if (!picks.length){ msg.textContent = 'No matching objects.'; return; }
    picks.forEach(rec => addItem(rec, fromY, toY));
    msg.textContent = `Showing ${picks.length} random objects from ${fromY}–${toY}.`;
  }catch(err){
    console.error(err);
    msg.textContent = 'Error retrieving data.';
  }
}

function addItem(rec, fromY, toY){
  const img   = rec._images?._primary_thumbnail;
  const iiif  = rec._images?._iiif_image_base_url;
  if(!img || !iiif) return;

  // 再做一次日期区间重检，确保 API 返回范围更宽时能过滤
  if(!dateOverlaps(rec._primaryDate, fromY, toY)) return;

  const objectType = rec.objectType || rec._primaryObjectName || 'Object';
  const title      = rec._primaryTitle || objectType;       // ◎ 新增：无标题 → objectType
  const dateStr    = rec._primaryDate || '';
  const maker      = rec._primaryMaker?.name || 'unknown';

  grid.insertAdjacentHTML('beforeend', `
    <div class="item">
      <img src="${img}" alt="${title}"
           onclick="window.open('${iiif}full/768,/0/default.jpg','_blank')" />
      <p><strong>${title}</strong><br>${dateStr}<br><em>${maker}</em></p>
    </div>`);
}

// true ↔ artwork’s date (单年或范围) 与查询区间有交集
function dateOverlaps(dateStr, fromY, toY){
  const yrs = (dateStr||'').match(/-?\d{1,4}/g)?.map(Number) || [];
  if(!yrs.length) return true;                 // 无日期信息则保留
  const min = Math.min(...yrs), max = Math.max(...yrs);
  return !(max < fromY || min > toY);
}
</script>
</body>
</html>
